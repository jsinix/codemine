#!/usr/bin/perl
use strict;
use warnings;
use Mail::POP3Client;
use IO::Socket::SSL;
use CGI qw(:standard);
use Net::SMTP::TLS;
# There will be a bug using the Net::SMTP::TLS module
# So the fix i found here:
# http://crunchbang.org/forums/viewtopic.php?pid=361299
# invalid SSL_version specified at /usr/share/perl5/IO/Socket/SSL.pm line
# replace this: m{^(!?)(?:(SSL(?:v2|v3|v23|v2/3))|(TLSv1[12]?))$}i
# with this: m{^(!?)(?:(SSL(?:v2|v3|v23|v2/3))|(TLSv1[12]?))}i
use Term::ReadKey;
use Switch;
use Mail::IMAPClient;
use Term::ANSIColor qw(:constants);

# Declaring all variables
my $cgi;
my $username;
my $password;
my $mailhost;
my $port;
my $pop;
my $count;
my $i;
my $uname;
my $pass;
my $emailto;
my $emailbody;
my $mailer;
my $emaillogin;
my $uname1;
my $pass1;
my $choice = '';

while ($choice ne '3') {
	START:
	system("clear");
	
	print BOLD, BLUE, "\n\n\n\n\tJSINIX Gmailer\n\n", RESET;
	print "\n\t1. Send email".
	      "\n\t2. Check email\n".
	      "\n\t3. Quit(q)";	
	
	print "\n\n\tChoice: ";
	$choice = <STDIN>;
	chomp($choice);
	
	switch ($choice) {

		case '1'
		{
			system("clear");
			mail_send();
			print "\n\tPress enter to continue"; <STDIN>; 
			goto START;
		}

		case '2'
		{
			system("clear");
			mail_check_pop();
			print "\n\tPress enter to continue"; <STDIN>; 
                        goto START;
		}

		case '3'
		{
			system("clear");
                        exit();
		}

		case 'q'
                {
                        system("clear");
                        exit();
                }		

	}
}

sub mail_check_pop { 
	$cgi = new CGI;

	($uname1, $pass1) = get_credentials();

	$mailhost = 'pop.gmail.com';
	$port = '995';

	#print $cgi->header();

	$pop = Mail::POP3Client->new(USER=> $uname1,
		PASSWORD => $pass1,
		HOST => $mailhost,
		PORT => $port,
		USESSL => 'true',
		DEBUG => 0,) or die("\n\tERROR: Unable to connect to mail server.\n");

	$count = $pop->Count();

	if (($pop->Count()) < 1)
	{
		print "\n\tNo messages...\n";
		print "\n\tPress enter to continue"; <STDIN>;
		goto START;
	}

	print "\n\tThere are $count Messages in your inbox\n";
	
	print "How many messages you want to print: ";
	my $eno = <STDIN>;
	chomp($eno);	

	for(my $i = 1; $i <= $eno; $i++)
		{
			print "\n\n\nMail number $1\n";
			foreach($pop->Head($i))
			{
				/^(From|Subject|Email):\s+/i && print $_, "\n";
			}
		print 'Message: '.$pop->Body($i);
		}	

	$pop->Close();

}

mail_send();
sub mail_send {

	my ($uname2, $pass2) = get_credentials();

	print "\n\tMail To: ";
	my $emailto = <STDIN>;
	chomp($emailto);

	print "\n\tBody: ";
	my $emailbody = <STDIN>;
	chomp($emailbody);

	my $mailer = new Net::SMTP::TLS(
		'smtp.gmail.com',
		Hello => 'smtp.gmail.com',
		Port => 587,
		User => $uname2,
		Password=> $pass2);

		$mailer->mail($emailto);
		$mailer->to($emailto);
		$mailer->data;
		$mailer->datasend($emailbody);
		$mailer->dataend;
		$mailer->quit;
		print "\n\tEmail sent.";
}

sub get_credentials {

        print "\n\tLogin ID: ";
        my $emaillogin = <STDIN>;
        chomp($emaillogin);

        print "\tPassword: ";
        ReadMode('noecho');
        chomp(my $password = <STDIN>);
        ReadMode(0);

	return ($emaillogin, $password);
}

sub mail_check_imap {

	my ($uname3, $pass3) = get_credentials();

	my $imap = Mail::IMAPClient->new ( Server => 'imap.gmail.com',
                                User => $uname3,
                                Password => $pass3,
                                Port => 993,
                                Ssl => 1,
                                Uid => 1 )
	or die "\n\tCould not connect to server, terminating...\n";
}
